# Matrix Server Setup

This directory contains a complete Matrix homeserver setup with Synapse, Element Web client, and Synapse Admin UI.

## Services Included

- **Synapse**: Official Matrix homeserver (matrixdotorg/synapse:latest)
- **PostgreSQL**: Database backend (postgres:16-alpine)
- **Redis**: Cache for improved performance (redis:7.2-alpine)
- **Element Web**: Browser-based Matrix client (vectorim/element-web:latest)
- **Synapse Admin**: Web-based admin UI (awesometechnologies/synapse-admin:latest)

## URLs

After deployment, you'll access:

- **Matrix Server**: https://matrix.bowline.im
- **Element Web Client**: https://element.bowline.im
- **Admin Interface**: https://matrix-admin.bowline.im
- **Federation**: Port 8448 (for server-to-server communication)

## Configuration Files

This setup uses version-controlled configuration files:

- **docker-compose.yml**: Service definitions
- **.env**: Environment variables (generated from .env.example)
- **synapse-config.yaml**: Custom Synapse configuration (version controlled)
- **element-config.json**: Element Web client configuration

The setup uses a two-layer configuration approach:
1. Base config auto-generated by Synapse in `/data/homeserver.yaml`
2. Custom config overlaid from `synapse-config.yaml` (version controlled)

## Initial Setup

### 1. Configure Environment Variables

```bash
cd /home/bowlinedandy/homelab/matrix
cp .env.example .env
nano .env
```

Update `.env` with:
- `POSTGRES_PASSWORD`: Generate with `openssl rand -base64 32`
- `SUBDOMAIN`: Your desired subdomain (e.g., `matrix` or `chat`)
- `CONFIG_PATH`: Path to store data (default: /mnt/docker-data)
- `PUID`/`PGID`: Your user/group IDs (usually 1000)

### 2. Update synapse-config.yaml

Edit `synapse-config.yaml` and replace `${POSTGRES_PASSWORD}` with your actual password:

```bash
nano synapse-config.yaml
# Find the database section and replace ${POSTGRES_PASSWORD}
```

### 3. Create External Networks (if not already created)

```bash
docker network create frontend 2>/dev/null || true
```

### 4. Generate Base Synapse Configuration

Generate the signing keys and base config:

```bash
docker compose run --rm synapse generate
```

This creates:
- `/data/homeserver.yaml` (base config)
- `/data/bowline.im.signing.key` (signing key)
- `/data/bowline.im.log.config` (logging config)

### 5. Start the Services

```bash
docker compose up -d
```

Check logs to ensure everything started correctly:

```bash
docker compose logs -f
```

### 6. Create Your First Admin User

Once Synapse is running, create an admin user:

```bash
docker exec -it synapse register_new_matrix_user \
  http://localhost:8008 \
  -c /data/homeserver.yaml \
  --admin
```

You'll be prompted for:
- Username (e.g., `admin`)
- Password
- Confirmation

Your Matrix ID will be: `@admin:bowline.im`

## Federation Setup

Your Matrix server is configured for federation (connecting with other Matrix servers like matrix.org).

### Firewall Configuration

Ensure port 8448 is accessible from the internet:

```bash
# Check if port is open
sudo ss -tulpn | grep 8448

# If using UFW, allow the port
sudo ufw allow 8448/tcp comment 'Matrix Federation'
```

### DNS Configuration

For proper federation, you need these DNS records:

1. **A Record**: `matrix.bowline.im` → Your server IP
2. **SRV Record** (optional but recommended):
   ```
   _matrix._tcp.bowline.im. 3600 IN SRV 10 0 8448 matrix.bowline.im.
   ```

### Test Federation

After setup, test federation at: https://federationtester.matrix.org/

## Using the Services

### Element Web Client

1. Visit https://element.bowline.im
2. Click "Sign In"
3. If using your homeserver for the first time, click "Edit" and ensure:
   - Homeserver: `https://matrix.bowline.im`
   - Server name: `bowline.im`
4. Log in with your Matrix ID (`@username:bowline.im`) and password

### Synapse Admin UI

1. Visit https://matrix-admin.bowline.im
2. Enter your homeserver URL: `https://matrix.bowline.im`
3. Log in with an admin account
4. Manage users, rooms, and server settings

## User Management

### Register New Users (via CLI)

If registration is disabled (recommended), create users via CLI:

```bash
docker exec -it synapse register_new_matrix_user \
  http://localhost:8008 \
  -c /data/homeserver.yaml
```

Add `--admin` flag to create an admin user.

### Enable Public Registration

To allow public registration:

1. Edit `.env`:
   ```bash
   ENABLE_REGISTRATION=true
   ```

2. Edit `homeserver.yaml`:
   ```yaml
   enable_registration: true
   enable_registration_without_verification: true  # or false if you want email verification
   ```

3. Restart Synapse:
   ```bash
   docker compose restart synapse
   ```

## Maintenance

### View Logs

```bash
# All services
docker compose logs -f

# Specific service
docker compose logs -f synapse
docker compose logs -f postgres
```

### Backup

Important directories to backup:

```bash
${CONFIG_PATH}/matrix/synapse/     # Synapse data, keys, and config
${CONFIG_PATH}/matrix/postgres/    # Database
${CONFIG_PATH}/matrix/redis/       # Redis cache (optional)
```

### Update Services

```bash
cd /home/bowlinedandy/homelab/matrix
docker compose pull
docker compose up -d
```

### Database Maintenance

Access PostgreSQL:

```bash
docker exec -it matrix-postgres psql -U synapse -d synapse
```

### Reset Everything

To completely reset and start over:

```bash
docker compose down -v
rm -rf ${CONFIG_PATH}/matrix/
# Then follow initial setup again
```

## Troubleshooting

### Check Service Status

```bash
docker compose ps
```

### Synapse Not Starting

1. Check logs: `docker compose logs synapse`
2. Verify homeserver.yaml syntax
3. Ensure PostgreSQL is running: `docker compose ps postgres`
4. Check database connection

### Federation Issues

1. Test federation: https://federationtester.matrix.org/
2. Verify port 8448 is accessible from internet
3. Check DNS records
4. Verify `server_name` in homeserver.yaml matches your domain

### Can't Connect from Element

1. Verify Traefik labels are correct
2. Check that services are on `frontend` network
3. Test direct access: `curl -k https://matrix.bowline.im/_matrix/client/versions`
4. Check Traefik dashboard for routing

### Database Connection Errors

1. Verify PostgreSQL password in both `.env` and `homeserver.yaml`
2. Check PostgreSQL is running: `docker compose ps postgres`
3. Ensure services are on the same network

## Performance Tuning

### Increase Worker Count

For high-traffic servers, consider adding Synapse workers (see Synapse documentation).

### Database Connection Pool

Edit `homeserver.yaml`:

```yaml
database:
  args:
    cp_min: 10
    cp_max: 20
```

### Redis Configuration

Redis is already configured for caching. For additional performance, consider:

```yaml
# In docker-compose.yml, add to redis command:
command: redis-server --save 60 1 --loglevel warning --maxmemory 256mb --maxmemory-policy allkeys-lru
```

## Security Recommendations

1. **Keep registration disabled** unless you need public registration
2. **Use strong passwords** for admin accounts
3. **Regular updates**: Run `docker compose pull` weekly
4. **Enable rate limiting**: Already configured in homeserver.yaml
5. **Monitor logs**: Check for suspicious activity
6. **Backup regularly**: Especially signing keys and database

## Additional Features

### Email Notifications

Edit `homeserver.yaml` and configure the email section:

```yaml
email:
  smtp_host: your-smtp-server.com
  smtp_port: 587
  smtp_user: your-smtp-user
  smtp_pass: your-smtp-password
  require_transport_security: true
  notif_from: "Matrix <noreply@bowline.im>"
  app_name: Matrix
  enable_notifs: true
```

### TURN Server (for VoIP)

For voice/video calls behind NAT, configure a TURN server:

```yaml
turn_uris:
  - "turn:turn.bowline.im:3478?transport=udp"
  - "turn:turn.bowline.im:3478?transport=tcp"
turn_shared_secret: "your-turn-secret"
turn_user_lifetime: 86400000
```

## Resources

- **Matrix Documentation**: https://matrix.org/docs/
- **Synapse Documentation**: https://matrix-org.github.io/synapse/latest/
- **Element Documentation**: https://element.io/help
- **Federation Tester**: https://federationtester.matrix.org/
- **Matrix Community**: #synapse:matrix.org

## Network Architecture

```
Internet
   ↓
Traefik (Port 443 HTTPS, Port 8448 Federation)
   ↓
┌─────────────────────────────────────────┐
│         Frontend Network (external)      │
│  ┌──────────────────────────────────┐   │
│  │ Synapse  │ Element │ Admin UI    │   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────┐
│      Matrix Network (internal only)      │
│  ┌──────────────────────────────────┐   │
│  │ PostgreSQL      │    Redis       │   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

## Configuration Files Reference

- **docker-compose.yml**: Service definitions and networking
- **.env**: Environment variables (create from .env.example)
- **homeserver.yaml**: Synapse server configuration
- **element-config.json**: Element Web client configuration
